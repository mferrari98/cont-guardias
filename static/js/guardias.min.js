document.addEventListener('DOMContentLoaded',function(){initTheme();highlightToday();initLeyendaFilter();});function cargarPronosticoAsincrono(){const btn=document.getElementById('btn-clima');if(!btn)return;btn.innerHTML='<span class="btn-icon">‚è≥</span>';btn.disabled=true;btn.title='Cargando pron√≥stico...';fetch('/guardias/api/clima').then(response=> response.json()).then(data=>{console.log('Respuesta del API:',data);if(data.success){aplicarPronostico(data.clima);btn.innerHTML='<span class="btn-icon">üå§Ô∏è</span>';btn.title='Pron√≥stico cargado';btn.style.opacity='0.5';btn.disabled=true;mostrarNotificacion('‚úÖ Pron√≥stico cargado correctamente');}else{btn.innerHTML='<span class="btn-icon">‚ùå</span>';btn.title='Error al cargar-Click para reintentar';btn.disabled=false;mostrarNotificacion('‚ùå Error al cargar el pron√≥stico');}}).catch(error=>{console.error('Error:',error);btn.innerHTML='<span class="btn-icon">üå§Ô∏è</span>';btn.title='Error-Click para reintentar';btn.disabled=false;mostrarNotificacion('‚ùå Error de conexi√≥n');});}function mostrarNotificacion(mensaje){const notifAnterior=document.getElementById('notificacion-clima');if(notifAnterior){notifAnterior.remove();}const notif=document.createElement('div');notif.id='notificacion-clima';notif.className='notificacion-clima';notif.textContent=mensaje;document.body.appendChild(notif);setTimeout(()=> notif.classList.add('show'),10);setTimeout(()=>{notif.classList.remove('show');setTimeout(()=> notif.remove(),300);},3000);}function solicitarPronostico(){const btn=document.getElementById('btn-clima');btn.innerHTML='<span class="btn-clima-text">‚è≥</span>';btn.disabled=true;btn.title='Cargando...';btn.style.opacity='1';fetch('/guardias/api/clima').then(response=> response.json()).then(data=>{console.log('Respuesta manual del API:',data);if(data.success){aplicarPronostico(data.clima);btn.innerHTML='<span class="btn-clima-text">‚úÖ Cargado</span>';btn.title='Pron√≥stico cargado';btn.style.opacity='0.7';btn.disabled=true;mostrarNotificacion('‚úÖ Pron√≥stico cargado correctamente');}else{btn.innerHTML='<span class="btn-clima-text">‚ùå Error</span>';btn.title='Error-Click para reintentar';btn.disabled=false;mostrarNotificacion('‚ùå Error al cargar');setTimeout(()=>{btn.innerHTML='<span class="btn-clima-text">Solicitar Pron√≥stico</span>';},2000);}}).catch(error=>{console.error('Error:',error);btn.innerHTML='<span class="btn-clima-text">‚ùå Error</span>';btn.title='Error-Click para reintentar';btn.disabled=false;mostrarNotificacion('‚ùå Error de conexi√≥n');setTimeout(()=>{btn.innerHTML='<span class="btn-clima-text">Solicitar Pron√≥stico</span>';},2000);});}function aplicarPronostico(climaData){console.log('Aplicando pron√≥stico a las celdas:',Object.keys(climaData).length,'fechas');console.log('Datos completos:',climaData);console.log('Primera fecha en datos:',Object.keys(climaData)[0]);const hoy=new Date();const a√±o=hoy.getFullYear();const mes=String(hoy.getMonth()+1).padStart(2,'0');const dia=String(hoy.getDate()).padStart(2,'0');const hoyStr=`${a√±o}-${mes}-${dia}`;console.log('Fecha de hoy(local):',hoyStr);let celdasActualizadas=0;let celdasEncontradas=0;Object.keys(climaData).forEach(fecha=>{const climaInfo=climaData[fecha];const celdas=document.querySelectorAll(`.dia-celda[data-fecha="${fecha}"]`);celdasEncontradas+=celdas.length;let emoji,tempMax,tempMin;if(typeof climaInfo==='string'){emoji=climaInfo;tempMax='';tempMin='';console.log(`Fecha ${fecha}: formato STRING,no hay temperaturas`);}else if(typeof climaInfo==='object'){emoji=climaInfo.emoji;tempMax=climaInfo.temp_max || '';tempMin=climaInfo.temp_min || '';console.log(`Fecha ${fecha}: formato OBJETO,temp_max=${tempMax},temp_min=${tempMin}`);}else{console.error(`Formato inesperado para fecha ${fecha}:`,climaInfo);return;}console.log(`Fecha ${fecha}: encontradas ${celdas.length}celdas,emoji: ${emoji}`);celdas.forEach(celda=>{const fechaCelda=celda.getAttribute('data-fecha');const esGuardiaRestante=celda.classList.contains('guardia-actual-highlight');const esHoy=celda.classList.contains('today');console.log(`-Celda fecha="${fechaCelda}": guardia-restante=${esGuardiaRestante},hoy=${esHoy}`);let emojiSpan=celda.querySelector('.clima-emoji');if(!emojiSpan){emojiSpan=document.createElement('span');emojiSpan.className='clima-emoji';celda.appendChild(emojiSpan);}emojiSpan.textContent=emoji;celdasActualizadas++;celda.setAttribute('data-temp-max',tempMax);celda.setAttribute('data-temp-min',tempMin);celda.setAttribute('data-clima-emoji',emoji);celda.addEventListener('mouseenter',mostrarTooltipClima);celda.addEventListener('mouseleave',ocultarTooltipClima);});});console.log(`Total de celdas encontradas: ${celdasEncontradas}`);console.log(`Total de celdas actualizadas con pron√≥stico: ${celdasActualizadas}`);}function mostrarTooltipClima(event){const celda=event.currentTarget;const guardia=celda.getAttribute('data-guardia');const emoji=celda.getAttribute('data-clima-emoji');const tempMax=celda.getAttribute('data-temp-max');const tempMin=celda.getAttribute('data-temp-min');const tooltip=document.createElement('div');tooltip.id='clima-tooltip-custom';tooltip.className='clima-tooltip-custom';let contenido=`<div class="tooltip-guardia-name">${guardia}</div>`;contenido+=`<div class="tooltip-clima-emoji">${emoji}</div>`;if(tempMax && tempMin && tempMax !=='null' && tempMin !=='null'){contenido+=`<div class="tooltip-temps">‚Üë ${tempMax}¬∞C/‚Üì ${tempMin}¬∞C</div>`;}tooltip.innerHTML=contenido;document.body.appendChild(tooltip);const rect=celda.getBoundingClientRect();const tooltipRect=tooltip.getBoundingClientRect();tooltip.style.left=rect.left+(rect.width/2)-(tooltipRect.width/2)+'px';tooltip.style.top=rect.top-tooltipRect.height-10+window.scrollY+'px';}function ocultarTooltipClima(){const tooltip=document.getElementById('clima-tooltip-custom');if(tooltip){tooltip.remove();}}function initTheme(){const themeCheckbox=document.getElementById('theme-checkbox');const html=document.documentElement;const savedTheme=localStorage.getItem('theme')|| 'dark';html.setAttribute('data-theme',savedTheme);if(savedTheme==='light'){themeCheckbox.checked=false;}else{themeCheckbox.checked=true;}if(themeCheckbox){themeCheckbox.addEventListener('change',function(){const newTheme=this.checked ? 'dark' : 'light';html.setAttribute('data-theme',newTheme);localStorage.setItem('theme',newTheme);});}}function highlightToday(){const todasLasCeldas=document.querySelectorAll('.dia-celda[data-es-hoy="True"]');todasLasCeldas.forEach(celda=>{celda.classList.add('today');});}let filtroActivo=null;function initLeyendaFilter(){const leyendaItems=document.querySelectorAll('.leyenda-item');leyendaItems.forEach(item=>{item.style.cursor='pointer';item.addEventListener('click',function(){const guardiaName=this.getAttribute('data-guardia');const feriadosCount=this.getAttribute('data-feriados');if(filtroActivo===guardiaName){desactivarFiltro();filtroActivo=null;ocultarTooltip();}else{activarFiltro(guardiaName);filtroActivo=guardiaName;mostrarInfoGuardia(guardiaName,feriadosCount);}});});}function activarFiltro(guardiaName){const leyendaItems=document.querySelectorAll('.leyenda-item');const todasLasCeldas=document.querySelectorAll('.dia-celda');leyendaItems.forEach(item=>{if(item.getAttribute('data-guardia')===guardiaName){item.style.opacity='1';item.style.transform='scale(1.05)';item.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)';}else{item.style.opacity='0.4';item.style.filter='grayscale(100%)';}});todasLasCeldas.forEach(celda=>{const guardiaData=celda.getAttribute('data-guardia');if(guardiaData && guardiaData===guardiaName){celda.style.opacity='1';celda.style.filter='none';}else{celda.style.opacity='0.3';celda.style.filter='grayscale(80%)';}});}function desactivarFiltro(){const leyendaItems=document.querySelectorAll('.leyenda-item');const todasLasCeldas=document.querySelectorAll('.dia-celda');leyendaItems.forEach(item=>{item.style.opacity='1';item.style.transform='scale(1)';item.style.boxShadow='';item.style.filter='none';});todasLasCeldas.forEach(celda=>{celda.style.opacity='1';celda.style.filter='none';});}function mostrarInfoGuardia(guardiaName,feriadosCount){const hoy=new Date();const info=calcularProximaGuardia(guardiaName,hoy);ocultarTooltip();const tooltip=document.createElement('div');tooltip.id='guardia-tooltip';tooltip.className='guardia-tooltip';let mensaje='';if(info.estaDeGuardia){mensaje=` <div class="tooltip-title">${guardiaName}</div> <div class="tooltip-detail"><strong>Guardia actual</strong></div> <div class="tooltip-detail">Hasta: ${info.fechaFin}</div> <div class="tooltip-detail">Quedan: ${info.diasRestantes}d√≠as</div> <div class="tooltip-feriados"> <div class="feriados-count">${feriadosCount}feriados/a√±o</div> </div> `;}else{mensaje=` <div class="tooltip-title">${guardiaName}</div> <div class="tooltip-detail"><strong>Pr√≥xima guardia</strong></div> <div class="tooltip-detail">En ${info.diasHastaProxima}d√≠as</div> <div class="tooltip-detail">${info.fechaProxima}</div> <div class="tooltip-feriados"> <div class="feriados-count">${feriadosCount}feriados/a√±o</div> </div> `;}tooltip.innerHTML=mensaje;document.body.appendChild(tooltip);}function ocultarTooltip(){const tooltip=document.getElementById('guardia-tooltip');if(tooltip){tooltip.remove();}}function calcularProximaGuardia(guardiaName,fechaActual){const celdasGuardia=[];const todasLasCeldas=document.querySelectorAll('.dia-celda');todasLasCeldas.forEach(celda=>{const guardiaData=celda.getAttribute('data-guardia');const fechaData=celda.getAttribute('data-fecha');if(guardiaData===guardiaName && fechaData){const fecha=new Date(fechaData);celdasGuardia.push(fecha);}});celdasGuardia.sort((a,b)=> a-b);const hoyStr=fechaActual.toISOString().split('T')[0];let guardiaActualInicio=null;let guardiaActualFin=null;let estaDeGuardia=false;for(let i=0;i < celdasGuardia.length;i++){const fechaStr=celdasGuardia[i].toISOString().split('T')[0];if(fechaStr===hoyStr){estaDeGuardia=true;guardiaActualInicio=celdasGuardia[i];for(let j=i-1;j >=0;j--){const diff=(celdasGuardia[j+1]-celdasGuardia[j])/(1000*60*60*24);if(diff <=1){guardiaActualInicio=celdasGuardia[j];}else{break;}}guardiaActualFin=celdasGuardia[i];for(let j=i+1;j < celdasGuardia.length;j++){const diff=(celdasGuardia[j]-celdasGuardia[j-1])/(1000*60*60*24);if(diff <=1){guardiaActualFin=celdasGuardia[j];}else{break;}}break;}}if(estaDeGuardia){const diasRestantes=Math.ceil((guardiaActualFin-fechaActual)/(1000*60*60*24))+1;return{estaDeGuardia: true,diasRestantes: diasRestantes,fechaInicio: formatearFecha(guardiaActualInicio),fechaFin: formatearFecha(guardiaActualFin)};}else{const proximaFecha=celdasGuardia.find(fecha=> fecha > fechaActual);if(proximaFecha){const diasHasta=Math.ceil((proximaFecha-fechaActual)/(1000*60*60*24));return{estaDeGuardia: false,diasHastaProxima: diasHasta,fechaProxima: formatearFecha(proximaFecha)};}}return{estaDeGuardia: false,diasHastaProxima: 0,fechaProxima: 'No disponible'};}function formatearFecha(fecha){const dia=fecha.getDate();const mes=fecha.getMonth()+1;const anio=fecha.getFullYear();return `${dia.toString().padStart(2,'0')}/${mes.toString().padStart(2,'0')}/${anio}`;}