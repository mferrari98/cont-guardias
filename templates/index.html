<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Guardias</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' fill='none'><rect width='64' height='64' rx='12' fill='%231a1f2e'/><rect width='64' height='64' rx='12' fill='none' stroke='%232a3140' stroke-width='2'/><path d='M32 16L20 21V31C20 39 25 45 32 48C39 45 44 39 44 31V21L32 16Z' fill='white' stroke='white' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/guardias.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha384-ZZ1pncU3bQe8y31yfZdMFdSpttDoPmOZg2wguVK9almUodir1PghgT0eY7Mrty8H" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <!-- Top bar estilo portal -->
        <div class="topbar">
            <div class="topbar-inner">
                <div class="topbar-left">
                    <div class="brand-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                        </svg>
                    </div>
                    <a class="brand-name" href="/">Telecomunicaciones y Automatismos</a>
                </div>
                <div class="topbar-right">
                    <div class="theme-toggle-fixed">
                        <input type="checkbox" id="theme-checkbox" class="theme-checkbox">
                        <label for="theme-checkbox" class="theme-label" aria-label="Cambiar tema">
                            <svg class="theme-icon sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="4" />
                                <path d="M12 2v2" />
                                <path d="M12 20v2" />
                                <path d="m4.93 4.93 1.41 1.41" />
                                <path d="m17.66 17.66 1.41 1.41" />
                                <path d="M2 12h2" />
                                <path d="M20 12h2" />
                                <path d="m6.34 17.66-1.41 1.41" />
                                <path d="m19.07 4.93-1.41 1.41" />
                            </svg>
                            <svg class="theme-icon moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9z" />
                            </svg>
                            <div class="theme-ball"></div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header principal -->
        <header class="page-header">
            <div class="page-title">
                <h1>Cronograma de guardias</h1>
                <p class="info-subtitle">
                    Internos: 2207 (Calandra), 2234 (Comunicaciones)
                </p>
            </div>
        </header>

        <!-- Contenedor con leyenda e info -->
        <div class="leyenda-info-row">
            <!-- Grupo 1: Botón pronóstico (izquierda) -->
            <div class="grupo-izquierda">
                <button id="btn-clima" class="btn-clima-rect" onclick="solicitarPronostico()" title="Cargar pronóstico del tiempo" data-clima-url="{{ url_for('obtener_clima') }}">
                    <span class="btn-clima-text">Solicitar Pronóstico</span>
                </button>
            </div>

            <!-- Grupo 2: Leyenda centrada (centro) -->
            <div class="leyenda">
                {% for guardia in guardias %}
                <div class="leyenda-item"
                     data-guardia="{{ guardia }}"
                     data-feriados="{{ feriados_por_guardia[guardia] }}"
                     style="--guardia-color: {{ colores[guardia] }};">
                    <span class="leyenda-label">{{ guardia }}</span>
                </div>
                {% endfor %}
            </div>

            <!-- Grupo 3: Info simple (derecha) -->
            <div class="grupo-derecha">
                <div class="info-simple">
                <span class="info-text">Cel: {{ celular }}</span>
                {% if guardia_actual %}
                <span class="info-separador">|</span>
                <span class="info-text">Guardia: {{ guardia_actual.nombre }}</span>
                {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabla única con todo el año -->
        <div id="calendario-captura" class="tabla-anual">

            <table class="calendario-completo">
                <thead>
                    <tr>
                        <th></th>
                        {% for dia in range(1, 32) %}
                        <th>{{ dia }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for mes_data in meses_data %}
                    <tr>
                        <td class="mes-label">{{ mes_data.mes }}</td>
                        
                        {% for dia in mes_data.fila %}
                            {% if dia %}
                                <td class="dia-celda
                                    {% if dia.es_feriado %}feriado-{{ dia.tipo_feriado }}{% endif %}
                                    {% if dia.es_hoy %}today{% endif %}"
                                    style="background-color: {{ dia.color }}; color: #000;"
                                    title="{% if dia.es_feriado %}{{ dia.nombre_feriado }}{% else %}{{ dia.guardia }}{% endif %}"
                                    data-fecha="{{ mes_data.anio }}-{{ '%02d'|format(mes_data.mes_numero) }}-{{ '%02d'|format(dia.dia) }}"
                                    data-guardia="{{ dia.guardia }}"
                                    data-es-hoy="{{ dia.es_hoy }}">
                                    <span class="dia-numero">{{ dia.dia_semana }}</span>
                                    {% if dia.emoji_clima %}
                                    <span class="clima-emoji">{{ dia.emoji_clima }}</span>
                                    {% endif %}
                                </td>
                            {% else %}
                                <td class="dia-vacio"></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Controles de navegación con botón de descarga -->
        <div class="controles-wrapper">
            <div class="controles">
                <button onclick="cambiarAnio(-1)">← {{ anio - 1 }}</button>
                <button style="border-color: var(--accent-primary); color: var(--accent-primary);">{{ anio }}</button>
                <button onclick="cambiarAnio(1)">{{ anio + 1 }} →</button>
            </div>
            <button class="btn-download" onclick="descargarCalendario()">
                Descargar calendario
            </button>
        </div>

        <div class="bottom-actions">
            <button class="btn-portal" onclick="window.history.back()" type="button">
                ← Volver
            </button>
        </div>

    </div>
<script>
        // Pasar datos de Python a JavaScript
        const feriadosPorGuardia = {{ feriados_por_guardia|tojson }};
        const anioActual = {{ anio }};
        
        function cambiarAnio(delta) {
            window.location.href = '/guardias/anio/' + (anioActual + delta);
        }


        function descargarCalendario() {
            const elemento = document.getElementById('calendario-captura');
            const btnDownload = document.querySelector('.btn-download');

            btnDownload.textContent = 'Generando...';
            btnDownload.disabled = true;

            const wrapper = document.createElement('div');
            wrapper.style.cssText = `
                background: ${getComputedStyle(elemento).backgroundColor};
                padding: 20px;
                display: inline-block;
            `;

            const titulo = document.createElement('h2');
            titulo.textContent = 'Cronograma de Guardias ' + anioActual;
            titulo.style.cssText = `
                text-align: center;
                margin-bottom: 15px;
                color: ${getComputedStyle(document.body).color};
                font-family: ${getComputedStyle(document.body).fontFamily};
            `;

            const tablaClone = elemento.cloneNode(true);
            const anchoTabla = elemento.scrollWidth || elemento.offsetWidth;
            const altoTabla = elemento.scrollHeight || elemento.offsetHeight;
            tablaClone.style.overflow = 'visible';
            tablaClone.style.width = `${anchoTabla}px`;
            tablaClone.style.maxWidth = 'none';

            wrapper.appendChild(titulo);
            wrapper.appendChild(tablaClone);
            document.body.appendChild(wrapper);

            const anchoWrapper = wrapper.scrollWidth;
            const altoWrapper = wrapper.scrollHeight;

            html2canvas(wrapper, {
                backgroundColor: getComputedStyle(document.body).backgroundColor,
                scale: 2,
                width: anchoWrapper,
                height: altoWrapper,
                windowWidth: anchoWrapper,
                windowHeight: altoWrapper
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'cronograma-guardias-' + anioActual + '.png';
                link.href = canvas.toDataURL();
                link.click();

                document.body.removeChild(wrapper);

                btnDownload.textContent = 'Descargar calendario';
                btnDownload.disabled = false;
            });
        }
    </script>
    <script src="{{ url_for('static', filename='js/guardias.js') }}"></script>
</body>
</html>
