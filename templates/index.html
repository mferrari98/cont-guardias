<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Guardias</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='b' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%23A8A4FF'/><stop offset='100%25' style='stop-color:%238B7FFF'/></linearGradient><linearGradient id='l' x1='0%25' y1='0%25' x2='0%25' y2='100%25'><stop offset='0%25' style='stop-color:%23FFFFFF'/><stop offset='100%25' style='stop-color:%23F0F0FF;stop-opacity:0.95'/></linearGradient></defs><circle cx='32' cy='32' r='30' fill='url(%23b)'/><circle cx='32' cy='32' r='30' fill='none' stroke='rgba(255,255,255,0.2)' stroke-width='1'/><path d='M 24 18 L 24 46 L 28 46 L 28 34 L 38 34 C 42 34 45 31 45 27 C 45 23 42 20 38 20 L 28 20 L 28 18 Z M 28 24 L 37 24 C 39.5 24 41 25.5 41 27 C 41 28.5 39.5 30 37 30 L 28 30 Z' fill='url(%23l)' stroke='rgba(139,127,255,0.3)' stroke-width='0.5'/></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/guardias.min.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha384-ZZ1pncU3bQe8y31yfZdMFdSpttDoPmOZg2wguVK9almUodir1PghgT0eY7Mrty8H" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <!-- Header con Toggle -->
        <header>
            <div>
                <h1>Cronograma guardias {{ anio }}</h1>
                <p class="info-subtitle">
                    Internos: 2207 (Calandra), 2234 (Comunicaciones)
                </p>
            </div>

            <!-- Toggle alineado con el t√≠tulo -->
            <div class="theme-toggle-fixed">
                <input type="checkbox" id="theme-checkbox" class="theme-checkbox">
                <label for="theme-checkbox" class="theme-label">
                    <img src="{{ url_for('static', filename='img/sun-icon.svg') }}" alt="Modo claro" class="theme-icon sun-icon">
                    <svg class="theme-icon moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                    <div class="theme-ball"></div>
                </label>
            </div>
        </header>

        <!-- Contenedor con leyenda e info -->
        <div class="leyenda-info-row">
            <!-- Grupo 1: Bot√≥n pron√≥stico (izquierda) -->
            <div class="grupo-izquierda">
                <button id="btn-clima" class="btn-clima-rect" onclick="solicitarPronostico()" title="Cargar pron√≥stico del tiempo">
                    <span class="btn-clima-text">Solicitar Pron√≥stico</span>
                </button>
            </div>

            <!-- Grupo 2: Leyenda centrada (centro) -->
            <div class="leyenda">
                {% for guardia in guardias %}
                <div class="leyenda-item"
                     data-guardia="{{ guardia }}"
                     data-feriados="{{ feriados_por_guardia[guardia] }}"
                     style="background-color: {{ colores[guardia] }}; color: #000;">
                    {{ guardia }}
                </div>
                {% endfor %}
            </div>

            <!-- Grupo 3: Info simple (derecha) -->
            <div class="grupo-derecha">
                <div class="info-simple">
                <span class="info-text">Cel: {{ celular }}</span>
                {% if guardia_actual %}
                <span class="info-separador">|</span>
                <span class="info-text">Guardia: {{ guardia_actual.nombre }}</span>
                {% endif %}
                </div>
            </div>
        </div>  
	</header>
                   
            <!-- Tabla √∫nica con todo el a√±o -->
        <div id="calendario-captura" class="tabla-anual">
            <table class="calendario-completo">
                <thead>
                    <tr>
                        <th></th>
                        {% for dia in range(1, 32) %}
                        <th>{{ dia }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for mes_data in meses_data %}
                    <tr>
                        <td class="mes-label">{{ mes_data.mes }}</td>
                        
                        {% for dia in mes_data.fila %}
                            {% if dia %}
                                <td class="dia-celda
                                    {% if dia.es_feriado %}feriado-{{ dia.tipo_feriado }}{% endif %}
                                    {% if dia.es_hoy %}today{% endif %}"
                                    style="background-color: {{ dia.color }}; color: #000;"
                                    title="{% if dia.es_feriado %}{{ dia.nombre_feriado }}{% else %}{{ dia.guardia }}{% endif %}"
                                    data-fecha="{{ mes_data.anio }}-{{ '%02d'|format(mes_data.mes_numero) }}-{{ '%02d'|format(dia.dia) }}"
                                    data-guardia="{{ dia.guardia }}"
                                    data-es-hoy="{{ dia.es_hoy }}">
                                    <span class="dia-numero">{{ dia.dia_semana }}</span>
                                    {% if dia.emoji_clima %}
                                    <span class="clima-emoji">{{ dia.emoji_clima }}</span>
                                    {% endif %}
                                </td>
                            {% else %}
                                <td class="dia-vacio"></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Controles de navegaci√≥n con bot√≥n de descarga -->
        <div class="controles-wrapper">
            <div class="controles">
                <button onclick="cambiarAnio(-1)">‚Üê {{ anio - 1 }}</button>
                <button style="border-color: var(--accent); color: var(--accent);">{{ anio }}</button>
                <button onclick="cambiarAnio(1)">{{ anio + 1 }} ‚Üí</button>
            </div>
            <button class="btn-download" onclick="descargarCalendario()">
                üì• Descargar calendario
            </button>
        </div>

        <!-- Footer id√©ntico al monitor -->
        <footer>
            <button class="btn-portal" onclick="window.history.back()">
                ‚Üê Volver
            </button>
            <div class="dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
            <div class="footer-text">Telecomunicaciones y Automatismos</div>
        </footer>
    </div>
<script>
        // Pasar datos de Python a JavaScript
        const feriadosPorGuardia = {{ feriados_por_guardia|tojson }};
        const anioActual = {{ anio }};
        
        function cambiarAnio(delta) {
            window.location.href = '/guardias/anio/' + (anioActual + delta);
        }


        function descargarCalendario() {
            const elemento = document.getElementById('calendario-captura');
            const btnDownload = document.querySelector('.btn-download');
            
            btnDownload.textContent = '‚è≥ Generando...';
            btnDownload.disabled = true;
            
            const wrapper = document.createElement('div');
            wrapper.style.cssText = `
                background: ${getComputedStyle(elemento).backgroundColor};
                padding: 20px;
                display: inline-block;
            `;
            
            const titulo = document.createElement('h2');
            titulo.textContent = 'Cronograma de Guardias ' + anioActual;
            titulo.style.cssText = `
                text-align: center;
                margin-bottom: 15px;
                color: ${getComputedStyle(document.body).color};
                font-family: ${getComputedStyle(document.body).fontFamily};
            `;
            
            wrapper.appendChild(titulo);
            wrapper.appendChild(elemento.cloneNode(true));
            document.body.appendChild(wrapper);
            
            html2canvas(wrapper, {
                backgroundColor: getComputedStyle(document.body).backgroundColor,
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'cronograma-guardias-' + anioActual + '.png';
                link.href = canvas.toDataURL();
                link.click();
                
                document.body.removeChild(wrapper);
                
                btnDownload.textContent = 'üì• Descargar calendario';
                btnDownload.disabled = false;
            });
        }
    </script>
    <script src="{{ url_for('static', filename='js/guardias.min.js') }}"></script>
</body>
</html>
